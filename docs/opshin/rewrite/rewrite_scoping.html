<!doctype html>
<html lang="en">
<head>
<style>.homelink{display:block;font-size:2em;font-weight:bold;color:#555;padding-bottom:.5em;border-bottom:1px solid silver}.homelink:hover{color:inherit}.homelink img{max-width:20%;max-height:5em;margin:auto;margin-bottom:.3em}</style>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.11.1" />
<link rel="icon" href="https://raw.githubusercontent.com/OpShin/opshin/dev/docs/opshin_32.png" sizes="32x32" type="image/png">
<title>opshin.rewrite.rewrite_scoping API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}#lunr-search{width:100%;font-size:1em;padding:6px 9px 5px 9px;border:1px solid silver}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<style>
.github-corner:hover .octo-arm {
animation: octocat-wave 560ms ease-in-out
}
@keyframes octocat-wave {
0%,
100% {
transform: rotate(0)
}
20%,
60% {
transform: rotate(-25deg)
}
40%,
80% {
transform: rotate(10deg)
}
}
@media (max-width:500px) {
.github-corner:hover .octo-arm {
animation: none
}
.github-corner .octo-arm {
animation: octocat-wave 560ms ease-in-out
}
}
</style>
<a href="https://github.com/opshin/opshin" class="github-corner" aria-label="View source on GitHub">
<svg width="80" height="80" viewBox="0 0 250 250"
style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
<path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z">
</path>
<path
d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
<path
d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
fill="currentColor" class="octo-body"></path>
</svg>
</a>
<article id="content">
<header>
<h1 class="title">Module <code>opshin.rewrite.rewrite_scoping</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import typing
from ast import *
from copy import copy

from ordered_set import OrderedSet

from .rewrite_forbidden_overwrites import FORBIDDEN_NAMES
from ..type_inference import INITIAL_SCOPE
from ..util import CompilingNodeTransformer, CompilingNodeVisitor

&#34;&#34;&#34;
Rewrites all variable names to point to the definition in the nearest enclosing scope
&#34;&#34;&#34;


class ShallowNameDefCollector(CompilingNodeVisitor):
    step = &#34;Collecting defined variable names&#34;

    def __init__(self):
        self.vars = OrderedSet()

    def visit_Name(self, node: Name) -&gt; None:
        if isinstance(node.ctx, Store):
            self.vars.add(node.id)

    def visit_ClassDef(self, node: ClassDef):
        self.vars.add(node.name)
        # methods will be put in global scope so add them now
        for attribute in node.body:
            if isinstance(attribute, FunctionDef):
                self.vars.add(attribute.name)
        # ignore the content (i.e. attribute names) of class definitions

    def visit_FunctionDef(self, node: FunctionDef):
        self.vars.add(node.name)
        # ignore the recursive stuff


class RewriteScoping(CompilingNodeTransformer):
    step = &#34;Rewrite all variables to inambiguously point to the definition in the nearest enclosing scope&#34;
    latest_scope_id: int
    scopes: typing.List[typing.Tuple[OrderedSet, int]]

    def variable_scope_id(self, name: str) -&gt; int:
        &#34;&#34;&#34;find the id of the scope in which this variable is defined (closest to its usage)&#34;&#34;&#34;
        name = name
        for scope, scope_id in reversed(self.scopes):
            if name in scope:
                return scope_id
        raise NameError(
            f&#34;free variable &#39;{name}&#39; referenced before assignment in enclosing scope&#34;
        )

    def enter_scope(self):
        self.scopes.append((OrderedSet(), self.latest_scope_id))
        self.latest_scope_id += 1

    def exit_scope(self):
        self.scopes.pop()

    def set_variable_scope(self, name: str):
        self.scopes[-1][0].add(name)

    def map_name(self, name: str):
        scope_id = self.variable_scope_id(name)
        if scope_id == -1:
            # do not rewrite Dict, Union, etc
            return name
        return f&#34;{name}_{scope_id}&#34;

    def visit_Module(self, node: Module) -&gt; Module:
        self.latest_scope_id = 0
        self.scopes = [(OrderedSet(INITIAL_SCOPE.keys() | FORBIDDEN_NAMES), -1)]
        node_cp = copy(node)
        self.enter_scope()
        # vars defined in this scope
        shallow_node_def_collector = ShallowNameDefCollector()
        for s in node.body:
            shallow_node_def_collector.visit(s)
        vars_def = shallow_node_def_collector.vars
        for var_name in vars_def:
            self.set_variable_scope(var_name)
        node_cp.body = [self.visit(s) for s in node.body]
        return node_cp

    def visit_Name(self, node: Name) -&gt; Name:
        nc = copy(node)
        # setting is handled in either enclosing module or function
        nc.id = self.map_name(node.id)
        return nc

    def visit_ClassDef(self, node: ClassDef) -&gt; ClassDef:
        cp_node = RecordScoper.scope(node, self)
        for i, attribute in enumerate(cp_node.body):
            if isinstance(attribute, FunctionDef):
                cp_node.body[i] = self.visit_FunctionDef(attribute, method=True)
        return cp_node

    def visit_FunctionDef(self, node: FunctionDef, method: bool = False) -&gt; FunctionDef:
        node_cp = copy(node)
        # setting is handled in either enclosing module or function
        node_cp.name = self.map_name(node.name) if not method else node.name
        self.enter_scope()
        node_cp.args = copy(node.args)
        node_cp.args.args = []
        # args are defined in this scope
        for a in node.args.args:
            a_cp = copy(a)
            self.set_variable_scope(a.arg)
            a_cp.arg = self.map_name(a.arg)
            a_cp.annotation = (
                self.visit(a.annotation)
                if not hasattr(a.annotation, &#34;idSelf&#34;)
                else a.annotation
            )
            node_cp.args.args.append(a_cp)
        node_cp.returns = (
            self.visit(node.returns)
            if not hasattr(node.returns, &#34;idSelf&#34;)
            else node.returns
        )
        # vars defined in this scope
        shallow_node_def_collector = ShallowNameDefCollector()
        for s in node.body:
            shallow_node_def_collector.visit(s)
        vars_def = shallow_node_def_collector.vars
        for var_name in vars_def:
            self.set_variable_scope(var_name)
        # map all vars and recurse
        node_cp.body = [self.visit(s) for s in node.body]
        self.exit_scope()
        return node_cp

    def visit_NoneType(self, node: None) -&gt; None:
        return node


class RecordScoper(NodeTransformer):
    _scoper: RewriteScoping

    def __init__(self, scoper: RewriteScoping):
        self._scoper = scoper

    @classmethod
    def scope(cls, c: ClassDef, scoper: RewriteScoping) -&gt; ClassDef:
        f = cls(scoper)
        return f.visit(c)

    def visit_ClassDef(self, c: ClassDef) -&gt; ClassDef:
        node_cp = copy(c)
        node_cp.name = self._scoper.map_name(node_cp.name)
        return self.generic_visit(node_cp)

    def visit_AnnAssign(self, node: AnnAssign) -&gt; AnnAssign:
        assert isinstance(
            node.target, Name
        ), &#34;Record elements must have named attributes&#34;
        node_cp = copy(node)
        node_cp.annotation = self._scoper.visit(node_cp.annotation)
        return node_cp</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="opshin.rewrite.rewrite_scoping.RecordScoper"><code class="flex name class">
<span>class <span class="ident">RecordScoper</span></span>
<span>(</span><span>scoper: <a title="opshin.rewrite.rewrite_scoping.RewriteScoping" href="#opshin.rewrite.rewrite_scoping.RewriteScoping">RewriteScoping</a>)</span>
</code></dt>
<dd>
<div class="desc"><p>A :class:<code>NodeVisitor</code> subclass that walks the abstract syntax tree and
allows modification of nodes.</p>
<p>The <code>NodeTransformer</code> will walk the AST and use the return value of the
visitor methods to replace or remove the old node.
If the return value of
the visitor method is <code>None</code>, the node will be removed from its location,
otherwise it is replaced with the return value.
The return value may be the
original node in which case no replacement takes place.</p>
<p>Here is an example transformer that rewrites all occurrences of name lookups
(<code>foo</code>) to <code>data['foo']</code>::</p>
<p>class RewriteName(NodeTransformer):</p>
<pre><code>   def visit_Name(self, node):
       return Subscript(
           value=Name(id='data', ctx=Load()),
           slice=Constant(value=node.id),
           ctx=node.ctx
       )
</code></pre>
<p>Keep in mind that if the node you're operating on has child nodes you must
either transform the child nodes yourself or call the :meth:<code>generic_visit</code>
method for the node first.</p>
<p>For nodes that were part of a collection of statements (that applies to all
statement nodes), the visitor may also return a list of nodes rather than
just a single node.</p>
<p>Usually you use the transformer like this::</p>
<p>node = YourTransformer().visit(node)</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class RecordScoper(NodeTransformer):
    _scoper: RewriteScoping

    def __init__(self, scoper: RewriteScoping):
        self._scoper = scoper

    @classmethod
    def scope(cls, c: ClassDef, scoper: RewriteScoping) -&gt; ClassDef:
        f = cls(scoper)
        return f.visit(c)

    def visit_ClassDef(self, c: ClassDef) -&gt; ClassDef:
        node_cp = copy(c)
        node_cp.name = self._scoper.map_name(node_cp.name)
        return self.generic_visit(node_cp)

    def visit_AnnAssign(self, node: AnnAssign) -&gt; AnnAssign:
        assert isinstance(
            node.target, Name
        ), &#34;Record elements must have named attributes&#34;
        node_cp = copy(node)
        node_cp.annotation = self._scoper.visit(node_cp.annotation)
        return node_cp</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>ast.NodeTransformer</li>
<li>ast.NodeVisitor</li>
</ul>
<h3>Static methods</h3>
<dl>
<dt id="opshin.rewrite.rewrite_scoping.RecordScoper.scope"><code class="name flex">
<span>def <span class="ident">scope</span></span>(<span>c: ast.ClassDef, scoper: <a title="opshin.rewrite.rewrite_scoping.RewriteScoping" href="#opshin.rewrite.rewrite_scoping.RewriteScoping">RewriteScoping</a>) ‑> ast.ClassDef</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="opshin.rewrite.rewrite_scoping.RecordScoper.visit_AnnAssign"><code class="name flex">
<span>def <span class="ident">visit_AnnAssign</span></span>(<span>self, node: ast.AnnAssign) ‑> ast.AnnAssign</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RecordScoper.visit_ClassDef"><code class="name flex">
<span>def <span class="ident">visit_ClassDef</span></span>(<span>self, c: ast.ClassDef) ‑> ast.ClassDef</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping"><code class="flex name class">
<span>class <span class="ident">RewriteScoping</span></span>
</code></dt>
<dd>
<div class="desc"><p>A :class:<code>NodeVisitor</code> subclass that walks the abstract syntax tree and
allows modification of nodes.</p>
<p>The <code>NodeTransformer</code> will walk the AST and use the return value of the
visitor methods to replace or remove the old node.
If the return value of
the visitor method is <code>None</code>, the node will be removed from its location,
otherwise it is replaced with the return value.
The return value may be the
original node in which case no replacement takes place.</p>
<p>Here is an example transformer that rewrites all occurrences of name lookups
(<code>foo</code>) to <code>data['foo']</code>::</p>
<p>class RewriteName(NodeTransformer):</p>
<pre><code>   def visit_Name(self, node):
       return Subscript(
           value=Name(id='data', ctx=Load()),
           slice=Constant(value=node.id),
           ctx=node.ctx
       )
</code></pre>
<p>Keep in mind that if the node you're operating on has child nodes you must
either transform the child nodes yourself or call the :meth:<code>generic_visit</code>
method for the node first.</p>
<p>For nodes that were part of a collection of statements (that applies to all
statement nodes), the visitor may also return a list of nodes rather than
just a single node.</p>
<p>Usually you use the transformer like this::</p>
<p>node = YourTransformer().visit(node)</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class RewriteScoping(CompilingNodeTransformer):
    step = &#34;Rewrite all variables to inambiguously point to the definition in the nearest enclosing scope&#34;
    latest_scope_id: int
    scopes: typing.List[typing.Tuple[OrderedSet, int]]

    def variable_scope_id(self, name: str) -&gt; int:
        &#34;&#34;&#34;find the id of the scope in which this variable is defined (closest to its usage)&#34;&#34;&#34;
        name = name
        for scope, scope_id in reversed(self.scopes):
            if name in scope:
                return scope_id
        raise NameError(
            f&#34;free variable &#39;{name}&#39; referenced before assignment in enclosing scope&#34;
        )

    def enter_scope(self):
        self.scopes.append((OrderedSet(), self.latest_scope_id))
        self.latest_scope_id += 1

    def exit_scope(self):
        self.scopes.pop()

    def set_variable_scope(self, name: str):
        self.scopes[-1][0].add(name)

    def map_name(self, name: str):
        scope_id = self.variable_scope_id(name)
        if scope_id == -1:
            # do not rewrite Dict, Union, etc
            return name
        return f&#34;{name}_{scope_id}&#34;

    def visit_Module(self, node: Module) -&gt; Module:
        self.latest_scope_id = 0
        self.scopes = [(OrderedSet(INITIAL_SCOPE.keys() | FORBIDDEN_NAMES), -1)]
        node_cp = copy(node)
        self.enter_scope()
        # vars defined in this scope
        shallow_node_def_collector = ShallowNameDefCollector()
        for s in node.body:
            shallow_node_def_collector.visit(s)
        vars_def = shallow_node_def_collector.vars
        for var_name in vars_def:
            self.set_variable_scope(var_name)
        node_cp.body = [self.visit(s) for s in node.body]
        return node_cp

    def visit_Name(self, node: Name) -&gt; Name:
        nc = copy(node)
        # setting is handled in either enclosing module or function
        nc.id = self.map_name(node.id)
        return nc

    def visit_ClassDef(self, node: ClassDef) -&gt; ClassDef:
        cp_node = RecordScoper.scope(node, self)
        for i, attribute in enumerate(cp_node.body):
            if isinstance(attribute, FunctionDef):
                cp_node.body[i] = self.visit_FunctionDef(attribute, method=True)
        return cp_node

    def visit_FunctionDef(self, node: FunctionDef, method: bool = False) -&gt; FunctionDef:
        node_cp = copy(node)
        # setting is handled in either enclosing module or function
        node_cp.name = self.map_name(node.name) if not method else node.name
        self.enter_scope()
        node_cp.args = copy(node.args)
        node_cp.args.args = []
        # args are defined in this scope
        for a in node.args.args:
            a_cp = copy(a)
            self.set_variable_scope(a.arg)
            a_cp.arg = self.map_name(a.arg)
            a_cp.annotation = (
                self.visit(a.annotation)
                if not hasattr(a.annotation, &#34;idSelf&#34;)
                else a.annotation
            )
            node_cp.args.args.append(a_cp)
        node_cp.returns = (
            self.visit(node.returns)
            if not hasattr(node.returns, &#34;idSelf&#34;)
            else node.returns
        )
        # vars defined in this scope
        shallow_node_def_collector = ShallowNameDefCollector()
        for s in node.body:
            shallow_node_def_collector.visit(s)
        vars_def = shallow_node_def_collector.vars
        for var_name in vars_def:
            self.set_variable_scope(var_name)
        # map all vars and recurse
        node_cp.body = [self.visit(s) for s in node.body]
        self.exit_scope()
        return node_cp

    def visit_NoneType(self, node: None) -&gt; None:
        return node</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="opshin.util.CompilingNodeTransformer" href="../util.html#opshin.util.CompilingNodeTransformer">CompilingNodeTransformer</a></li>
<li><a title="opshin.util.TypedNodeTransformer" href="../util.html#opshin.util.TypedNodeTransformer">TypedNodeTransformer</a></li>
<li>ast.NodeTransformer</li>
<li>ast.NodeVisitor</li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.latest_scope_id"><code class="name">var <span class="ident">latest_scope_id</span> : int</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.scopes"><code class="name">var <span class="ident">scopes</span> : List[Tuple[ordered_set.OrderedSet, int]]</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.step"><code class="name">var <span class="ident">step</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.enter_scope"><code class="name flex">
<span>def <span class="ident">enter_scope</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.exit_scope"><code class="name flex">
<span>def <span class="ident">exit_scope</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.map_name"><code class="name flex">
<span>def <span class="ident">map_name</span></span>(<span>self, name: str)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.set_variable_scope"><code class="name flex">
<span>def <span class="ident">set_variable_scope</span></span>(<span>self, name: str)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.variable_scope_id"><code class="name flex">
<span>def <span class="ident">variable_scope_id</span></span>(<span>self, name: str) ‑> int</span>
</code></dt>
<dd>
<div class="desc"><p>find the id of the scope in which this variable is defined (closest to its usage)</p></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.visit"><code class="name flex">
<span>def <span class="ident">visit</span></span>(<span>self, node)</span>
</code></dt>
<dd>
<p class="inheritance">
<em>Inherited from:</em>
<code><a title="opshin.util.CompilingNodeTransformer" href="../util.html#opshin.util.CompilingNodeTransformer">CompilingNodeTransformer</a></code>.<code><a title="opshin.util.CompilingNodeTransformer.visit" href="../util.html#opshin.util.CompilingNodeTransformer.visit">visit</a></code>
</p>
<div class="desc inherited"><p>Visit a node.</p></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.visit_ClassDef"><code class="name flex">
<span>def <span class="ident">visit_ClassDef</span></span>(<span>self, node: ast.ClassDef) ‑> ast.ClassDef</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.visit_FunctionDef"><code class="name flex">
<span>def <span class="ident">visit_FunctionDef</span></span>(<span>self, node: ast.FunctionDef, method: bool = False) ‑> ast.FunctionDef</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.visit_Module"><code class="name flex">
<span>def <span class="ident">visit_Module</span></span>(<span>self, node: ast.Module) ‑> ast.Module</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.visit_Name"><code class="name flex">
<span>def <span class="ident">visit_Name</span></span>(<span>self, node: ast.Name) ‑> ast.Name</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.RewriteScoping.visit_NoneType"><code class="name flex">
<span>def <span class="ident">visit_NoneType</span></span>(<span>self, node: None) ‑> None</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector"><code class="flex name class">
<span>class <span class="ident">ShallowNameDefCollector</span></span>
</code></dt>
<dd>
<div class="desc"><p>A node visitor base class that walks the abstract syntax tree and calls a
visitor function for every node found.
This function may return a value
which is forwarded by the <code>visit</code> method.</p>
<p>This class is meant to be subclassed, with the subclass adding visitor
methods.</p>
<p>Per default the visitor functions for the nodes are <code>'visit_'</code> +
class name of the node.
So a <code>TryFinally</code> node visit function would
be <code>visit_TryFinally</code>.
This behavior can be changed by overriding
the <code>visit</code> method.
If no visitor function exists for a node
(return value <code>None</code>) the <code>generic_visit</code> visitor is used instead.</p>
<p>Don't use the <code>NodeVisitor</code> if you want to apply changes to nodes during
traversing.
For this a special visitor exists (<code>NodeTransformer</code>) that
allows modifications.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ShallowNameDefCollector(CompilingNodeVisitor):
    step = &#34;Collecting defined variable names&#34;

    def __init__(self):
        self.vars = OrderedSet()

    def visit_Name(self, node: Name) -&gt; None:
        if isinstance(node.ctx, Store):
            self.vars.add(node.id)

    def visit_ClassDef(self, node: ClassDef):
        self.vars.add(node.name)
        # methods will be put in global scope so add them now
        for attribute in node.body:
            if isinstance(attribute, FunctionDef):
                self.vars.add(attribute.name)
        # ignore the content (i.e. attribute names) of class definitions

    def visit_FunctionDef(self, node: FunctionDef):
        self.vars.add(node.name)
        # ignore the recursive stuff</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="opshin.util.CompilingNodeVisitor" href="../util.html#opshin.util.CompilingNodeVisitor">CompilingNodeVisitor</a></li>
<li><a title="opshin.util.TypedNodeVisitor" href="../util.html#opshin.util.TypedNodeVisitor">TypedNodeVisitor</a></li>
<li>ast.NodeVisitor</li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.step"><code class="name">var <span class="ident">step</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit"><code class="name flex">
<span>def <span class="ident">visit</span></span>(<span>self, node)</span>
</code></dt>
<dd>
<p class="inheritance">
<em>Inherited from:</em>
<code><a title="opshin.util.CompilingNodeVisitor" href="../util.html#opshin.util.CompilingNodeVisitor">CompilingNodeVisitor</a></code>.<code><a title="opshin.util.CompilingNodeVisitor.visit" href="../util.html#opshin.util.CompilingNodeVisitor.visit">visit</a></code>
</p>
<div class="desc inherited"><p>Visit a node.</p></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit_ClassDef"><code class="name flex">
<span>def <span class="ident">visit_ClassDef</span></span>(<span>self, node: ast.ClassDef)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit_FunctionDef"><code class="name flex">
<span>def <span class="ident">visit_FunctionDef</span></span>(<span>self, node: ast.FunctionDef)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit_Name"><code class="name flex">
<span>def <span class="ident">visit_Name</span></span>(<span>self, node: ast.Name) ‑> None</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<div style="max-width: 330px; margin-bottom: 10px">
<header>
<a class="homelink" rel="home" title="opshin Home" href="https://opshin.opshin.dev/">
<img src="https://raw.githubusercontent.com/OpShin/opshin/master/opshin.png" alt="opshin logo"> &nbsp; opshin
</a>
</header>
</div>
<form>
<input id="lunr-search" name="q" placeholder="🔎 Search ..." aria-label="Search"
disabled minlength="2">
</form>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tingle/0.16.0/tingle.min.css" integrity="sha512-b+T2i3P45i1LZM7I00Ci5QquB9szqaxu+uuk5TUSGjZQ4w4n+qujQiIuvTv2BxE7WCGQCifNMksyKILDiHzsOg==" crossorigin>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tingle/0.16.0/tingle.min.js" integrity="sha512-2B9/byNV1KKRm5nQ2RLViPFD6U4dUjDGwuW1GU+ImJh8YinPU9Zlq1GzdTMO+G2ROrB5o1qasJBy1ttYz0wCug==" crossorigin></script>
<style>
.modal-dialog iframe {
width: 100vw;
height: calc(100vh - 80px);
}
@media screen and (min-width: 700px) {
.modal-dialog iframe {
width: 70vw;
height: 80vh;
}
}
.modal-dialog .tingle-modal-box {width: auto;}
.modal-dialog .tingle-modal-box__content {padding: 0;}
</style>
<script>
const input = document.getElementById('lunr-search');
input.disabled = false;
input.form.addEventListener('submit', (ev) => {
ev.preventDefault();
const url = new URL(window.location);
url.searchParams.set('q', input.value);
history.replaceState({}, null, url.toString());
search(input.value);
});
const query = new URL(window.location).searchParams.get('q');
if (query)
search(query);
function search(query) {
const url = '../../doc-search.html#' + encodeURIComponent(query);
new tingle.modal({
cssClass: ['modal-dialog'],
onClose: () => {
const url = new URL(window.location);
url.searchParams.delete('q');
history.replaceState({}, null, url.toString());
setTimeout(() => input.focus(), 100);
}
}).setContent('<iframe src="' + url + '"></iframe>').open();
}
</script>
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="opshin.rewrite" href="index.html">opshin.rewrite</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="opshin.rewrite.rewrite_scoping.RecordScoper" href="#opshin.rewrite.rewrite_scoping.RecordScoper">RecordScoper</a></code></h4>
<ul class="">
<li><code><a title="opshin.rewrite.rewrite_scoping.RecordScoper.scope" href="#opshin.rewrite.rewrite_scoping.RecordScoper.scope">scope</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RecordScoper.visit_AnnAssign" href="#opshin.rewrite.rewrite_scoping.RecordScoper.visit_AnnAssign">visit_AnnAssign</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RecordScoper.visit_ClassDef" href="#opshin.rewrite.rewrite_scoping.RecordScoper.visit_ClassDef">visit_ClassDef</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping" href="#opshin.rewrite.rewrite_scoping.RewriteScoping">RewriteScoping</a></code></h4>
<ul class="two-column">
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.enter_scope" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.enter_scope">enter_scope</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.exit_scope" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.exit_scope">exit_scope</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.latest_scope_id" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.latest_scope_id">latest_scope_id</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.map_name" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.map_name">map_name</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.scopes" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.scopes">scopes</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.set_variable_scope" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.set_variable_scope">set_variable_scope</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.step" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.step">step</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.variable_scope_id" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.variable_scope_id">variable_scope_id</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.visit" href="../util.html#opshin.rewrite.rewrite_scoping.RewriteScoping.visit">visit</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.visit_ClassDef" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.visit_ClassDef">visit_ClassDef</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.visit_FunctionDef" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.visit_FunctionDef">visit_FunctionDef</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.visit_Module" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.visit_Module">visit_Module</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.visit_Name" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.visit_Name">visit_Name</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.RewriteScoping.visit_NoneType" href="#opshin.rewrite.rewrite_scoping.RewriteScoping.visit_NoneType">visit_NoneType</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector" href="#opshin.rewrite.rewrite_scoping.ShallowNameDefCollector">ShallowNameDefCollector</a></code></h4>
<ul class="">
<li><code><a title="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.step" href="#opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.step">step</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit" href="../util.html#opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit">visit</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit_ClassDef" href="#opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit_ClassDef">visit_ClassDef</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit_FunctionDef" href="#opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit_FunctionDef">visit_FunctionDef</a></code></li>
<li><code><a title="opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit_Name" href="#opshin.rewrite.rewrite_scoping.ShallowNameDefCollector.visit_Name">visit_Name</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.1</a>.</p>
</footer>
</body>
</html>
